#!/usr/bin/tclsh
# -*- mode: Tcl; tab-width: 8; -*-
#
# Copyright (C) 2011, 2012 by Roger E Critchlow Jr, Santa Fe, NM, USA.
# 
# This program is free software; you can redistribute it and/or modify
# it under the terms of the GNU General Public License as published by
# the Free Software Foundation; either version 3 of the License, or
# (at your option) any later version.
# 
# This program is distributed in the hope that it will be useful,
# but WITHOUT ANY WARRANTY; without even the implied warranty of
# MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
# GNU General Public License for more details.
# 
# You should have received a copy of the GNU General Public License
# along with this program; if not, write to the Free Software
# Foundation, Inc., 59 Temple Place, Suite 330, Boston, MA  02111-1307 USA
# 

set script [expr { ! [catch {file readlink [info script]} link] ? $link : [info script]}]
lappend auto_path [file join [file dirname $script] .. lib]

package require Tk
package require sdrkit::midi-insert

# implement a key on mouse buttons or key presses

array set data {
    server default
    name mouse-key
    chan 1
    note 0
    midi-note-off		0x80
    midi-note-on		0x90
}

proc note-on {n} {
    $::data(name) puts [binary format ccc [expr {$::data(midi-note-on)|($::data(chan)-1)}] [expr {$::data(note)+($n&1)}] 0]
}

proc note-off {n} {
    $::data(name) puts [binary format ccc [expr {$::data(midi-note-off)|($::data(chan)-1)}] [expr {$::data(note)+($n&1)}] 0]
}

proc main {argv} {
    foreach {option value} $argv {
	switch -- $option {
	    -name - --name { set ::data(name) $value }
	    -s - -server - --server { set ::data(server) $value }
	    -c - -chan - --channel { set ::data(chan) $value }
	    -n - -note - --note { set ::data(note) $value }
	    default { error "unknown option \"$option\"" }
	}
    }
    sdrkit::midi-insert $::data(name)
    wm title . $::data(name)
    pack [canvas .c] -fill both -expand true
    bind .c <ButtonPress-1> [list note-on 0]
    bind .c <ButtonRelease-1> [list note-off 0]
    bind .c <ButtonPress-3> [list note-on 1]
    bind .c <ButtonRelease-3> [list note-off 1]
    focus .c
    bind .c <KeyPress> [list note-on %N]
    bind .c <KeyRelease> [list note-off %N]
    bind . <Destroy> [list shutdown %W]
}

main $argv
